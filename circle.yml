machine:
  environment:
    IMAGE_NAME: astronomerio/airflow
  services:
    - docker

dependencies:
  override:
    - docker info
    - >
      if [ -z ${CIRCLE_TAG+x} ]; then 
        docker build --rm=false --build-arg AIRFLOW_BRANCH=astronomer-fixes-staging -t $IMAGE_NAME; 
      else 
        docker build --rm=false -t $IMAGE_NAME; 
      fi

test:
  override: 
    - make lint
    - make test

deployment:
  production:
    tag: /[0-9]+(\.[0-9]+)*/
    owner: astronomerio
    commands:
      - git clone git@github.com:astronomerio/circle-scripts.git
      - sh ./circle-scripts/deploy-docker-hub.sh
  staging:
    branch: circleCI
    commands:
      - docker login -e $DOCKER_EMAIL -u $DOCKER_USER -p $DOCKER_PASS
      - docker push $IMAGE_NAME
